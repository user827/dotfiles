#!/bin/sh
set -eu

# run with cap_sys_admin

#https://ffmpeg.org/ffmpeg-devices.html#kmsgrab
# https://trac.ffmpeg.org/wiki/Hardware/VAAPI
# https://gist.github.com/Brainiarc7/95c9338a737aa36d9bb2931bed379219
# https://trac.ffmpeg.org/wiki/Capture/PulseAudio

ffmpeg \
  -f pulse -ac 2 -i default \
  -device /dev/dri/card1 -framerate 60 -f kmsgrab -i - \
  -vf 'hwmap=derive_device=vaapi,scale_vaapi=format=nv12' -c:v av1_vaapi -q:v 19 \
  -qscale:a 7 \
  "$1"
