#!/bin/sh
set -eu

. ~/.config/screencap.conf

# run with cap_sys_admin

# check vainfo for allowed codecs
# av1 has had bugs
codec=${codec:-hevc_vaapi}

# https://wiki.archlinux.org/title/Hardware_video_acceleration
#https://ffmpeg.org/ffmpeg-devices.html#kmsgrab
# https://trac.ffmpeg.org/wiki/Hardware/VAAPI
# https://gist.github.com/Brainiarc7/95c9338a737aa36d9bb2931bed379219
# https://trac.ffmpeg.org/wiki/Capture/PulseAudio
# https://gist.github.com/Brainiarc7/95c9338a737aa36d9bb2931bed379219
# https://trac.ffmpeg.org/wiki/Encode/AV1
# https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/22585/commits
# https://superuser.com/questions/1190153/make-mkv-file-suitable-for-streaming-with-ffmpeg-or-avconv-how-to-move-all-m
# https://gist.github.com/weedz/2717028bacfbdceed6522f3ced707e5f

#https://lists.ffmpeg.org/pipermail/ffmpeg-user/2020-November/050746.html

# needed after kmsgrab?
# -thread_queue_size 4096     \
# -use_wallclock_as_timestamps 1 -fflags +genpts \
# https://news.ycombinator.com/item?id=28622124
# https://sources.debian.org/src/ffmpeg/7%3A5.1.6-0%2Bdeb12u1/libavdevice/kmsgrab.c/
# - has pts = now

# hwdownload example
#https://wiki.tonytascioglu.com/scripts/ffmpeg/kmsgrab_screen_capture

# https://trac.ffmpeg.org/wiki/Encode/HighQualityAudio

# use -report switch to see internal recorded to a file

# if preview blocks, it block the encoding also

si=my-sink
if ! pactl list short sinks | grep "$si"; then
  echo loading sink
  pactl load-module module-null-sink media.class=Audio/Sink sink_name="$si" channel_map=stereo
fi
# To use the sink:
# PULSE_SINK=$si app

# Use .ts container if wanting to stream the container
# itsoffset so that there is no lag with ffplay preview
ffmpeg \
  -xerror -hide_banner \
  -thread_queue_size 1024 -f pulse -ac 2 -i "$si".monitor \
  -thread_queue_size 1024 -device /dev/dri/card1 -framerate 60 -f kmsgrab -i - \
  -thread_queue_size 1024 \
  -an -vf 'hwmap=derive_device=vaapi,scale_vaapi=w=1920:h=1080,hwdownload,format=bgr0' -f nut -c:v rawvideo - \
  -vf 'hwmap=derive_device=vaapi,scale_vaapi=format=nv12' -c:v "$codec" -q:v 22 \
  -c:a libopus -b:a 160k \
  -thread_queue_size 1024 \
  "$@" | mpv --profile=low-latency \
  --no-osc \
  --input-conf=/dev/null \
  --no-input-default-bindings \
  --no-input-terminal \
  --no-config \
  --really-quiet \
  --cursor-autohide=no \
  --no-cache \
  --no-audio \
  --untimed \
  --no-demuxer-thread \
  --video-sync=desync \
  --vd-lavc-threads=1 \
  --vd-lavc-dr=no \
  --hwdec=no \
  --speed=1 \
  --container-fps-override=60 \
  --no-correct-pts \
  --hr-seek=no \
  --demuxer-readahead-secs=0 \
  --demuxer-max-bytes=512K \
  -
# mpv stops screensaver
# preview outputs fixes ffmpeg ctrl-c
# -itsoffset -0.4 to both video and audio would fix delay on preview
# mpv --container-fps-override=60 is higher than in 60000/1001 which makes the preview catch up
