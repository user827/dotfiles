#!/bin/bash
set -eu

. ~/.config/capture.conf

# av1 gives 1082 resolution and bad decoding performance
# h264 gives smaller size and is slower eg better encoding
codec=${codec:-h264_vulkan}

# about q and qp see -report also that they match
# https://superuser.com/questions/1448982/will-i-get-any-visual-benefit-if-i-use-crf-values-below-17-18-in-x264-ffmpeg

dir=~/Videos/camstreamer
[ -d "$dir" ] || mkdir "$dir"
cd "$dir"

i=1

d=$(date +%F-%H-%M)
if [ $# -ge 1 ]; then
  out=$d-$i-$1.mkv
else
  out=$d-$i.mkv
fi

echo "saving to $PWD/$out"


while [ -e "$out" ]; do
  i=$((i + 1))
  if [ $# -ge 1 ]; then
    out=$d-$i-$1.mkv
  else
    out=$d-$i.mkv
  fi
done

shift

# For sync https://superuser.com/questions/1584945/ffmpeg-audio-start-time-way-off
#btime_=$(grep btime /proc/stat | awk '{print $2}')
#read -r utime_ _ < /proc/uptime
#btime_utime_=$(echo "${btime_?} + ${utime_?}" | bc -l)

# pactl list short sources
# ffplay -f video4linux2 -list_formats all /dev/video0

# sync issues
# https://forum.zdoom.org/viewtopic.php?t=75912

# https://trac.ffmpeg.org/wiki/Capture/PulseAudio
#https://trac.ffmpeg.org/wiki/Hardware/VAAPI
ffmpeg -hide_banner \
  -init_hw_device vaapi=foo:$vaapidev -hwaccel_output_format vaapi -hwaccel vaapi \
  -init_hw_device vulkan=vkdev:$vkdev -filter_hw_device vkdev \
  -itsoffset "$videodelay" -f v4l2 -framerate "$framerate" -input_format mjpeg -video_size "$resolution" -i /dev/video0 \
  -f pulse -ac 2 -i "$audiodevice" \
  -an -vf 'scale_vaapi=w=1280:h=720:format=bgra,hwdownload,format=bgr0' -f nut -c:v rawvideo - \
  -ss 1 -vf "scale_vaapi=format=nv12,hwdownload,format=nv12,hwupload" -c:v "$codec" \
  -b:a 160K -c:a libopus \
  "$out" -report \
  "$@" | ffplay -loglevel warning -

# List available formats
# ffplay -f video4linux2 -list_formats all /dev/video0
# https://ffmpeg.org/ffmpeg-devices.html#video4linux2_002c-v4l2

# For another cam
  #-f v4l2 -thread_queue_size 1024 -framerate 30 -input_format mjpeg -video_size 1920x1080 -i /dev/video0 \
  #-f pulse -thread_queue_size 1024 -i default \
  #-ac 2 -b:a 190k -c:a libopus \


# Other ways to preview
  # | mpv --cache=no --no-input-default-bindings --no-input-terminal --keep-open=no -
  # | ffplay -probesize 32 -sync ext -

# Deprecated
# -pix_fmt yuv420p -f sdl2 -window_enable_quit 0 -window_size 1280x720 "Webcam" \

# https://video.stackexchange.com/questions/10368/video-capture-using-ffmpeg-v4l2-indev-results-in-bad-a-v-sync
# https://superuser.com/questions/1584945/ffmpeg-audio-start-time-way-off
# https://stackoverflow.com/questions/16658873/how-to-minimize-the-delay-in-a-live-streaming-with-ffmpeg
# https://trac.ffmpeg.org/wiki/Encode/HighQualityAudio
# https://www.reddit.com/r/ffmpeg/comments/oa9f0x/ffmpeg_audio_aac_vs_opus/
