#!/bin/bash
set -eu

slowdown=
interpolate=
r=

text=

docrop=0
doloop=0
dointerpolate=0
while [ $# -gt 0 ]; do
  case "$1" in
    --maxwidth)
      maxwidth=$2
      shift 2
      ;;
    --height)
      height=$2
      shift 2
      ;;
    --crop)
      docrop=$2
      shift 2
      ;;
    --text)
      #https://ffmpeg.shanewhite.co/
      text=$2,
      shift 2
      ;;
    --loop)
      doloop=1
      shift
      ;;
    --slowdown)
      slowdown="-fflags +genpts -r $2"
      fps=$2
      shift 2
      ;;
    --interpolate)
      dointerpolate=$2
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

if [ -z "${maxwidth:-}" ]; then
  echo "No maxwidth specified" >&2
  exit 1
fi

if [ -z "${height:-}" ]; then
  echo "No height specified" >&2
  exit 1
fi

crop=
if [ "$docrop" != 0 ]; then
  IFS=: read -r h x y <<<"$docrop"
  crop=crop=w=$(( ((maxwidth * 1000 / height) * h) / 1000 )):h=$h:x=$x:y=$y,
  echo "$crop"
fi

if [ "$dointerpolate" != 0 ]; then
  # smoother than only interpolating to fps 30 when the input is jittery
  fps=$dointerpolate
  interpolate="minterpolate='fps=$dointerpolate',"
  r="-r 30"
fi

loop=
if [ "$doloop" != 0 ]; then
  #https://superuser.com/questions/1089525/how-to-loop-a-video-back-and-forth-with-ffmpeg
  loop="reverse[r];[0][r]concat,setpts=N/$fps/TB",
fi

file=$1
ss=$2
to=$3
shift 3

# https://askubuntu.com/questions/648603/how-to-create-an-animated-gif-from-mp4-video-via-command-line
ffmpeg \
  -ss "$ss" -to "$to" $slowdown \
  -i "$file" \
  -filter_complex "[0]${crop}scale=-1:$height,${interpolate}${loop}${text}split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" \
  $r "$@" "$file".gif
