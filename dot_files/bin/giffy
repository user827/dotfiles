#!/bin/bash
set -eu

slowdown=
interpolate=
text=
hold=
fade=
palettegen="split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse"
final_delay=

docrop=0
doboomerang=0
dointerpolate=0
dev=
yes=
custom=
while [ $# -gt 0 ]; do
  case "$1" in
    --yes)
      yes=-y
      shift
      ;;
    --custom)
      custom="$2,"
      echo hello
      shift 2
      ;;
    --final_delay)
      final_delay="-final_delay $2"
      shift 2
      ;;
    --dev)
      dev=1
      shift
      ;;
    --width)
      width=$2
      shift 2
      ;;
    --height)
      height=$2
      shift 2
      ;;
    --crop)
      # Also see panning with crop
      # https://ffmpeg.unixpin.com/2018/09/27/image-animation-pan/
      # https://stackoverflow.com/questions/39734065/ffmpeg-pan-across-image-without-zoom-in-or-out
      docrop=$2
      shift 2
      ;;
    --text)
      #https://ffmpeg.shanewhite.co/
      text=$2
      shift 2
      ;;
    --boomerang)
      doboomerang=1
      shift
      ;;
    --hold)
      hold="tpad=stop_duration=$2:stop_mode=clone"
      shift 2
      ;;
    --fade)
      fade="$2"
      shift 2
      ;;
    --slowdown)
      slowdown="setpts=$2*PTS"
      #https://stackoverflow.com/questions/72145599/ffmpeg-change-video-speed-with-r-vs-filter-and-setpts
      shift 2
      ;;
    --interpolate)
      dointerpolate=$2
      shift 2
      ;;
    --no-palettegen)
      palettegen=
      shift
      ;;
    --*)
      echo "Unknown arg $1" >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [ -z "${width:-}" ]; then
  echo "No width specified" >&2
  exit 1
fi

if [ -z "${height:-}" ]; then
  echo "No height specified" >&2
  exit 1
fi

crop=
if [ "$docrop" != 0 ]; then
  IFS=: read -r h x y <<<"$docrop"
  crop="crop=w=$(( ((width * 1000 / height) * h + 500) / 1000 )):h=$h:x=$x:y=$y,"
fi

if [ "$dointerpolate" != 0 ]; then
  # smoother than only interpolating to fps 30 when the input is jittery
  # remove hiccups also https://stackoverflow.com/questions/37088517/remove-sequentially-duplicate-frames-when-using-ffmpeg
  # https://www.reddit.com/r/ffmpeg/comments/koaq7h/replace_duplicates_with_resample/
  # https://trac.ffmpeg.org/wiki/How%20to%20speed%20up%20/%20slow%20down%20a%20video#Smooth
  # https://superuser.com/questions/1706239/using-ffmpeg-mpdecimate-to-get-rid-of-exact-duplicate-frames-i-e-losslessly
  interpolate="mpdecimate,minterpolate='mi_mode=mci:mc_mode=aobmc:vsbmc=1:fps=$dointerpolate'"
fi

boomerang=
if [ "$doboomerang" != 0 ]; then
  # https://stackoverflow.com/questions/2017843/fetch-frame-count-with-ffmpeg/28376817#28376817
  #https://superuser.com/questions/1089525/how-to-loop-a-video-back-and-forth-with-ffmpeg
  boomerang="split[int1][int2];[int2]trim=start_frame=1,setpts=PTS-STARTPTS,reverse,trim=start_frame=1,setpts=PTS-STARTPTS[r];[int1][r]concat"
  # TODO drops frames without
  #boomerang=",split[int1][int2];[int2]reverse[r];[int1][r]concat,setpts=N/$fps/TB"
  # ?
fi

echo "params $@"
out=$1
shift

filterstr=
if [ -n "$dev" ]; then
  filterstr="${custom}${crop}scale=-1:$height",
fi
for filter in \
  "${slowdown}" \
  "${interpolate}" \
  "${boomerang}" \
  "${hold}" \
  "${text}" \
  "${fade}"
do
  if [ -n "$filter" ]; then
    filterstr=$filterstr$filter,
  fi
done
if [ -z "$dev" ]; then
  filterstr=$filterstr${custom}${crop}scale=-1:$height
else
  filterstr=${filterstr%,}
fi
filterstr=$filterstr,${palettegen}
echo "$filterstr"

# https://askubuntu.com/questions/648603/how-to-create-an-animated-gif-from-mp4-video-via-command-line
# https://superuser.com/questions/1608327/ffmpeg-boomerang-effect-to-gif
echo "$@"
echo "out $out"
ffmpeg \
  "$@" \
  -filter_complex "$filterstr" \
  -an $final_delay $yes "$out"
