#!/bin/bash
set -eu

slowdown=
interpolate=

text=

docrop=0
doboomerang=0
dointerpolate=0
while [ $# -gt 0 ]; do
  case "$1" in
    --width)
      width=$2
      shift 2
      ;;
    --height)
      height=$2
      shift 2
      ;;
    --crop)
      docrop=$2
      shift 2
      ;;
    --text)
      #https://ffmpeg.shanewhite.co/
      text=,$2
      shift 2
      ;;
    --boomerang)
      doboomerang=1
      shift
      ;;
    --slowdown)
      slowdown=",setpts=$2*PTS"
      #https://stackoverflow.com/questions/72145599/ffmpeg-change-video-speed-with-r-vs-filter-and-setpts
      shift 2
      ;;
    --interpolate)
      dointerpolate=$2
      shift 2
      ;;
    --*)
      echo "Unknown arg $1" >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [ -z "${width:-}" ]; then
  echo "No width specified" >&2
  exit 1
fi

if [ -z "${height:-}" ]; then
  echo "No height specified" >&2
  exit 1
fi

crop=
if [ "$docrop" != 0 ]; then
  IFS=: read -r h x y <<<"$docrop"
  crop=crop=w=$(( ((width * 1000 / height) * h + 500) / 1000 )):h=$h:x=$x:y=$y,
  echo "$crop"
fi

if [ "$dointerpolate" != 0 ]; then
  # smoother than only interpolating to fps 30 when the input is jittery
  # remove hiccups also https://stackoverflow.com/questions/37088517/remove-sequentially-duplicate-frames-when-using-ffmpeg
  # https://www.reddit.com/r/ffmpeg/comments/koaq7h/replace_duplicates_with_resample/
  interpolate=",mpdecimate,minterpolate='fps=$dointerpolate'"
fi

boomerang=
if [ "$doboomerang" != 0 ]; then
  # https://stackoverflow.com/questions/2017843/fetch-frame-count-with-ffmpeg/28376817#28376817
  #https://superuser.com/questions/1089525/how-to-loop-a-video-back-and-forth-with-ffmpeg
  boomerang=",split[int1][int2];[int2]trim=start_frame=1,setpts=PTS-STARTPTS,reverse,trim=start_frame=1,setpts=PTS-STARTPTS[r];[int1][r]concat"
  # TODO drops frames without
  #boomerang=",split[int1][int2];[int2]reverse[r];[int1][r]concat,setpts=N/$fps/TB"
  # ?
fi

file=$1
ss=$2
to=$3
out=$4
shift 4

# https://askubuntu.com/questions/648603/how-to-create-an-animated-gif-from-mp4-video-via-command-line
# https://superuser.com/questions/1608327/ffmpeg-boomerang-effect-to-gif
ffmpeg \
  -ss "$ss" -to "$to" \
  -i "$file" \
  -filter_complex "${crop}scale=-1:$height${slowdown}${interpolate}${boomerang}${text},split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" \
  "$@" "$out".gif
