#!/bin/bash
set -eu

banner_printed=0
declare -A txprevs rxprevs totalrxs totaltxs
while true; do
  if [ $# = 0 ]; then
    ifaces=()
    for iface_path in /sys/class/net/*; do
      ifaces+=("${iface_path##*/}")
    done
  else
    ifaces=("$@")
  fi

  if [ ${#ifaces[@]} = 1 ]; then
    if [ $banner_printed = 0 ]; then
      echo "Listening $1..."
      banner_printed=1
    fi
  else
    banner_printed=0
  fi

  msg=
  for iface in "${ifaces[@]}"; do
    read -r rx < /sys/class/net/"$iface"/statistics/rx_bytes
    read -r tx < /sys/class/net/"$iface"/statistics/tx_bytes
    rxprev=${rxprevs[$iface]:-"-1"}
    txprev=${txprevs[$iface]:-"-1"}
    totalrx=${totalrxs[$iface]:-"0"}
    totaltx=${totaltxs[$iface]:-"0"}
    if [ "$rxprev" != -1 ]; then
      : $((bwrx=rx-rxprev)) $((bwtx=tx-txprev))
      : $((totalrx=totalrx+bwrx)) : $((totaltx=totaltx+bwtx))
      if [ "${#ifaces[@]}" = 1 ]; then
        printf '\rReceived: %6d KiB/s (%6d MiB)    Sent: %6d KiB/s (%6d MiB)' \
          $((bwrx/1024)) $((totalrx/(1024*1024) )) $((bwtx/1024)) $((totaltx/(1024*1024) ))
      else
        msg=$msg$(printf '%16s: Received: %6d KiB/s (%6d MiB)    Sent: %6d KiB/s (%6d MiB)\n' \
          "$iface" $((bwrx/1024)) $((totalrx/(1024*1024) )) $((bwtx/1024)) $((totaltx/(1024*1024) )))$'\n'
      fi
    fi
    rxprevs[$iface]=$rx
    txprevs[$iface]=$tx
    totaltxs[$iface]=$totaltx
    totalrxs[$iface]=$totalrx
  done
  if [ ${#ifaces[@]} -gt 1 ] && [ -n "$msg" ]; then
    printf '%s\n' "$msg"
  fi
  sleep 1
done
